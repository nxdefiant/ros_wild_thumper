<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />

		<link rel="stylesheet" href="assets/stylesheets/bootstrap.min.css">
		<link rel="stylesheet" href="assets/stylesheets/jquery-ui.css">
		<link rel="stylesheet" href="assets/stylesheets/jquery.minicolors.css">

		<style>
		.minicolors-theme-default.minicolors { margin: 5px; }
		</style>

		<script type="text/javascript">
		function init() {
			var ros = new ROSLIB.Ros();
			ros.connect('ws://wildthumper:9090');
			var isDragging = false;

			ros.on('connection', function() {
				$("#information").append(`
				<div class="alert alert-dismissible alert-success">
					<span data-dismiss="alert">Connected to websocket server.</span>
				</div>
				`);
			});

			ros.on('error', function(error) {
				$("#information").append(`
				<div class="alert alert-dismissible alert-danger">
					<span data-dismiss="alert">Error connecting to websocket server.</span>
				</div>
				`);
			});

			ros.on('close', function() {
				$("#information").append(`
				<div class="alert alert-dismissible alert-info">
					<span data-dismiss="alert">Connection to websocket server closed.</span>
				</div>
				`);
			});

			//tfClient.subscribe('base_link', function(tf) {
			//	var now = new Date();
			//	$("#pose").text(now.toLocaleTimeString() + ": (" + tf.translation.x + ", " + tf.translation.y + ")");

			//	robotMarker.x = tf.translation.x;
			//	robotMarker.y = -tf.translation.y;
			//	robotMarker.rotation = viewer2D.scene.rosQuaternionToGlobalTheta(tf.rotation);
			//});
			var poseTopic = new ROSLIB.Topic({ros: ros, name: '/robot_pose', messageType: 'geometry_msgs/Pose'});
			var sensorTopic = new ROSLIB.Topic({ros: ros, name: '/sensors', messageType: 'wild_thumper/Sensor'});
			var batteryTopic = new ROSLIB.Topic({ros: ros, name: '/battery', messageType: 'sensor_msgs/BatteryState'});
			var ledStripeTopic = new ROSLIB.Topic({ros: ros, name: '/led_stripe', messageType: 'wild_thumper/LedStripe'});

			poseTopic.subscribe(function(message) {
				var now = new Date();
				$("#pose").text(now.toLocaleTimeString() + ": (" + message.position.x + ", " + message.position.y + ")");
			});

			sensorTopic.subscribe(function(message) {
				sensordiv = $("#sensors")
				sensordiv.find("input[name=light]").val(message.light);
				sensordiv.find("input[name=temp]").val(message.temp.toFixed(1));
				sensordiv.find("input[name=humidity]").val(message.humidity);
				sensordiv.find("input[name=pressure]").val(message.pressure.toFixed(1));
				sensordiv.find("input[name=co]").val(message.co);
			});

			batteryTopic.subscribe(function(message) {
				powerdiv = $("#power");
				powerdiv.find("input[name=voltage]").val(message.voltage.toFixed(1));
				powerdiv.find("input[name=current]").val(message.current.toFixed(1));
			});

			viewer2D = new ROS2D.Viewer({
				divID: 'map',
				width: 640,
				height: 480,
				background: "#efefef"
			});
			$('#map')
			.bind('mousewheel', function(e) {
				if (e.originalEvent.wheelDelta/120 > 0) {
					viewer2D.scaleToDimensions(10, 10)
				} else {
					viewer2D.scaleToDimensions(5, 5)
				}
			})
			.mousedown(function() {
				isDragging = true;
				mousePreX = undefined;
				mousePreY = undefined;
			})
			.mouseup(function() {
				isDragging = false;
			})
			.mousemove(function(event) {
				if (isDragging) {
					if (mousePreX != undefined && mousePreY != undefined) {
						var diffX = event.pageX - mousePreX;
						var diffY = event.pageY - mousePreY;
						console.log("Moving viewer2D by " + diffX + ", " + diffY);
						viewer2D.shift(diffX, diffY);
					}
					mousePreX = event.pageX;
					mousePreY = event.pageY;
				}
			});

			// Setup the nav client.
			NAV2D.OccupancyGridClientNav({
				ros : ros,
				rootObject : viewer2D.scene,
				viewer : viewer2D,
				serverName : '/move_base'
			});

			// Initialize the teleop.
			var teleop = new KEYBOARDTELEOP.Teleop({
				ros : ros,
				topic : '/cmd_vel'
			});

			// Create a UI slider using JQuery UI.
			$('#speed-slider').slider({
				range : 'min',
				min : 0,
				max : 100,
				value : 50,
				slide : function(event, ui) {
					// Change the speed label.
					$('#speed-label').html('Speed: ' + ui.value + '%');
					// Scale the speed.
					teleop.scale = (ui.value / 100.0);
				}
			});

			// Set the initial speed.
			$('#speed-label').html('Speed: ' + ($('#speed-slider').slider('value')) + '%');
			teleop.scale = ($('#speed-slider').slider('value') / 100.0);

			$('.led_color').minicolors({
				control: 'wheel',
				format: 'rgb',
				defaultValue: '#000000',
				change: function(value) {
					var rgb = $(this).minicolors('rgbObject');
					var num = $(this).prop("name");
					var msg = new ROSLIB.Message({
						leds: [{
							num: parseInt(num),
							red: parseInt(rgb.r*127/255),
							green: parseInt(rgb.g*127/255),
							blue: parseInt(rgb.b*127/255)
						}]
					});
					ledStripeTopic.publish(msg);
				}
			});
		}
		</script>
		<title>Wild Thumper control</title>
	</head>
	<body onload="init()">
		<div class="container-fluid">
			<div id="information">
			</div>

			<nav class="navbar navbar-expand-lg navbar-light bg-light">
				<a class="navbar-brand" href="#">Wild Thumper</a>
				<ul class="nav nav-tabs" role="tablist">
					<li class="nav-item">
						<a class="nav-link active" href="#data" data-toggle="tab" role="tab">Data</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#navigation" data-toggle="tab" role="tab">Navigation</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#lights" data-toggle="tab" role="tab">Lights</a>
					</li>
				</ul>
			</nav>
			<div class="tab-content">
				<div id="data" class="tab-pane active" role="tabpanel">
					<div class="row">
						<div id="power" class="col-auto">
							<h4>Power</h4>
							<label>Voltage:</label>
							<div class="input-group">
								<input type=text name="voltage" class="form-control" readonly>
								<div class="input-group-append">
									<span class="input-group-text">V</span>
								</div>
							</div>
							<label>Current:</label>
							<div class="input-group">
								<input type=text name="current" class="form-control" readonly>
								<div class="input-group-append">
									<span class="input-group-text">A</span>
								</div>
							</div>
						</div>
						<div id="sensors" class="col-auto">
							<h4>Sensors</h4>
							<label>Light:</label>
							<div class="input-group">
								<input type=text name="light" class="form-control" readonly>
								<div class="input-group-append">
									<span class="input-group-text">lx</span>
								</div>
							</div>
							<label>Temperature:</label>
							<div class="input-group">
								<input type=text name="temp" class="form-control" readonly>
								<div class="input-group-append">
									<span class="input-group-text">&#x2103</span>
								</div>
							</div>
							<label>Humidity:</label>
							<div class="input-group">
								<input type=text name="humidity" class="form-control" readonly>
								<div class="input-group-append">
									<span class="input-group-text">%</span>
								</div>
							</div>
							<label>Pressure:</label>
							<div class="input-group">
								<input type=text name="pressure" class="form-control" readonly>
								<div class="input-group-append">
									<span class="input-group-text">kPa</span>
								</div>
							</div>
							<label>CO:</label>
							<input type=text name="co" class="form-control" readonly>
						</div>
					</div>
				</div>
				<div id="navigation" class="tab-pane" role="tabpanel">
					<div id="pose"></div>
					<div id="map"></div>
					<div id="speed-label"></div>
					<div id="speed-slider"></div>
				</div>
				<div id="lights" class="tab-pane" role="tabpanel">
					<div class="row d-flex align-items-center">
						<div class="col-md-1">
							<div class="float-right align-middle">
								<input class="led_color" type="hidden" name="15"/>
								<input class="led_color" type="hidden" name="14"/>
							</div>
						</div>
						<div class="col-md-2" >
							<div class="d-flex justify-content-center">
								<input class="led_color" type="hidden" name="0"/>
								<input class="led_color" type="hidden" name="1"/>
								<input class="led_color" type="hidden" name="2"/>
								<input class="led_color" type="hidden" name="3"/>
							</div>
							<div>
								<div style="background: url('assets/images/wt_top.png'); background-size: cover; background-size: 100%; background-repeat: no-repeat; height: 260px;">
									<div class="d-flex justify-content-center" style="padding-top: 70px;">
										<input class="led_color" type="hidden" name="7"/>
										<input class="led_color" type="hidden" name="6"/>
										<input class="led_color" type="hidden" name="5"/>
										<input class="led_color" type="hidden" name="4"/>
									</div>
								</div>
							</div>
							<div class="d-flex justify-content-center">
								<input class="led_color" type="hidden" name="8"/>
								<input class="led_color" type="hidden" name="9"/>
								<input class="led_color" type="hidden" name="10"/>
								<input class="led_color" type="hidden" name="11"/>
							</div>
						</div>
						<div class="col-md-1">
							<div class="float-left align-middle">
								<input class="led_color" type="hidden" name="13"/>
								<input class="led_color" type="hidden" name="12"/>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="assets/javascripts/jquery-3.3.1.min.js"></script>
		<script src="assets/javascripts/popper.min.js"></script>
		<script src="assets/javascripts/bootstrap.min.js"></script>
		<script src="assets/javascripts/jquery-ui.min.js"></script>
		<script src="assets/javascripts/easeljs.min.js"></script>
		<script src="assets/javascripts/eventemitter2.js"></script>
		<script src="assets/javascripts/roslib.js"></script>
		<script src="assets/javascripts/ros2d.js"></script>
		<script src="assets/javascripts/nav2d.js"></script>
		<script src="assets/javascripts/keyboardteleop.js"></script>
		<script src="assets/javascripts/jquery.minicolors.js"></script>
	</body>
</html>
